## Mars 原生雲設計架構

本雲端系統採用各微服務的協作的模式運作，並依賴一個叫 DataBroker 的服務，  
將所有的微服務串連起來。
  
<img src="https://test.mars-cloud.com/images/1713405966074.jpg" width="640"></img>

### Mars 微服務的原理與設計
  
而將所有服務串連的方法，便是透過呼叫 Restful API 與 MQTT 訊息服務來達  
成，統一為資料流的概念，稱作 Data Bus。因此，所有的微服務，都必須與  
DataBroker 進行註冊登記，在此前提下，系統便能統合與協調各種服務，並且  
達到負載平衡的功能。  

在本系統中，最小的運作單元就是一個微服務，也是一個可以獨立運作的程式。  
一個微服務會包含三個要素：

- Web Server
- Restful APIs
- Functions

其中的 Web Service 與 Restful APIs 運作，本系統透過架構與SDK，皆已  
完整處理，開發者無須花費時間建構該項目。因此，剩下的就是專注於 Restful  
APIs 的設計，以及 APIs 與 Funtions 的對應關係，並實現該服務的正確功  
能。詳細部分，可參考 [簡易微服務撰寫範例](/Services/SimpleService)。  

<img src="https://test.mars-cloud.com/images/1713409008905.jpg" width="480"></img>
    
這個概念，其實就是對 SaaS 微服務，進行功能設計與封裝。最後形成一個功能IC。  
而不同的微服務，就是一顆顆不同的 IC，最後透過 Pin 腳（APIs）連結，來完成  
整體功能的實現。因此，很多 IC 設計的經驗與技巧，就可以重複利用於 SaaS 的  
設計中。  

  
### Mars 微服務的 API 交互運作模式

當一個服務設計完成，並執行後，便可透過呼叫 APIs 來驅動功能。例如：  
  
```
http://[host]:[port]/api/hello
```

其中的 host 與 port 則是該服務運作的網路位址與通訊埠。如果該服務無須或  
是不打算與其他服務交互作用，這時便是一個可以獨立運作的微服務程式。掛上 HTML  
便可進行任務。而如果有需要與其他服務交互作用時，便需要註冊在 DataBroker 底  
下。本系統之架構，會自行進行註冊，只需要填對正確的註冊網址與帳號密碼。這些參  
數皆放在一個與微服務相同目錄下的設定檔案 agent.properties。詳細部分，一樣  
參考 [簡易微服務撰寫範例](/Services/SimpleService)。   

而微服務交互作用，大致分成兩個模式：  
  
- 委託執行模式： 委託 DataBroker 代為呼叫。
- 直接存取模式： 直接執行呼叫，但須明確知道該服務的通訊埠，並在同個網段內。

<img src="https://test.mars-cloud.com/images/1713411327233.jpg"></img>

畫面中，黃色箭頭的就是**委託執行模式**，效率雖然不如**直接存取模式**，但具有許  
多優點：**無須知道該服務位置**、**跨防火牆**、**雲端與地端可互通**、**自動負載平  
衡**。而**直接存取模式**，雖然會快一點（約 100 ～ 200 ms），但需要犧牲上述的諸多  
優點。因此設計時，需要考量個專案的特點，來設計服務間的交互運作模式。  

  
### Mars 微服務的 MQTT 運作模式

在 DataBroker 中，已內建 MQTT 3.X 版的 MQTT Server。而整個的運作結構，  
也已經設計在 SDK 中。因此設計者，只要專心在發送訊息與接收處理即可。本系統的  
MQTT 目前採用單向運作，每個微服務皆可訂閱與接收訊息，但不可以透過 MQTT Client  
發送訊息。發送訊息的動作，必須透過 DataBroker 的 API 來進行，有三種行為  
會觸發訊息的發送：
  
- 新增/更新資料： 任何更新資料庫的 API，皆會自動觸發訊息，可強制關閉。
- 新增/觸發事件： 發生系統事件或是呼叫 PutEvent 相關 API，會發出訊息。
- 發送自訂訊息 ： 透過 PutMessage 相關 API 發出自訂的訊息內容。

所有有註冊到系統的**微服務**、**設備**、**APP**、或**其他程式**，皆會加入這個訊息體系。  
至於要處理或是接收什麼訊息，就看設計功能時，需要處理哪些資料而定。

  
### Mars 微服務與 3rd 雲端介接

隨著雲端的整合越來越普遍，雲與雲的對接也是一個常見也必須的工作。在本系統中，  
要與其他的雲端系統對接，最簡單的方式，就是設計一個微服務，同時跨接兩個雲端。  

<img src="https://test.mars-cloud.com/images/1713422612845.jpg"></img>

這種方式，不僅安全，對長期開發還十分有效率。甚至，可以將這個微服務，擴增成  
多個 3rd 雲端的對接，如此一來就很容易在各種雲端之間交換資料或處理。
